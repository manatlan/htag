<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/mode-python.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/theme-cobalt.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ext-searchbox.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ext-language_tools.js"></script>
    
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <py-config>packages = ["htag==0.9.41"]</py-config>    
</head>

<body> Loading DEMO ;-)

<py-script>
###############################################################################
from htag import Tag
import urllib.parse
import base64,ast,json

class Ed(Tag.div):
    """ A class which embed the ace editor (python syntax) """
    def __init__(self,value,width="100%",height="100%",mode="python",onchange=None):
        self.value = value
        super().__init__(_style="width:%s;height:%s;" % (width,height))
        
        oed=Tag.div(self.value,_style="width:100%;height:100%;min-height:20px;")
        self <= oed
        self.onchange=onchange
    
        self.js = """
self.ed=ace.edit( "%s" );
self.ed.setTheme("ace/theme/cobalt");
self.ed.session.setMode("ace/mode/%s");
self.ed.session.setUseWrapMode(false);
self.ed.setOptions({"fontSize": "11pt"});
self.ed.setBehavioursEnabled(false);
self.ed.session.setUseWorker(false);
self.ed.getSession().setUseSoftTabs(true);

function commandSave () {%s}

self.ed.commands.addCommand({
    name: "commandSave",
    bindKey: {"win": "Ctrl-S",  "mac": "Command-S"},
    readOnly: "True",
    exec: commandSave,
})
""" % (id(oed),mode, self.bind._save( b"self.ed.getValue()"))

    def _save(self,value):
        self.value = value
        if self.onchange: self.onchange(self)

SRC="""
from htag import Tag

class App(Tag.body):
    def init(self):
        def say_hello(o):
            self <= Tag.li("hello")
        self <= Tag.button("click",_onclick = say_hello)
"""

def get_external_modules(code) -> list:
    # https://stackoverflow.com/questions/2572582/return-a-list-of-imported-python-modules-used-in-a-script
    modules = set()
    
    def visit_Import(node):
        for name in node.names:
            modules.add(name.name.split(".")[0])
    
    def visit_ImportFrom(node):
        # if node.module is missing it's a "from . import ..." statement
        # if level > 0 it's a "from .submodule import ..." statement
        if node.module is not None and node.level == 0:
            modules.add(node.module.split(".")[0])
    
    node_iter = ast.NodeVisitor()
    node_iter.visit_Import = visit_Import
    node_iter.visit_ImportFrom = visit_ImportFrom
    node_iter.visit(ast.parse(code))
    return list(modules - set(sys.stdlib_module_names))

def generate_pyscript(code:str) -> str:
    externals = get_external_modules(code)

    return """<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <py-config>
    packages = %s
    </py-config>    
</head>

<body>
<py-script>
###############################################################################
%s
###############################################################################
from htag.runners import PyScript
from js import window

PyScript( App ).run( window )
</py-script>
</body>
</html>""" % (json.dumps( externals ),code)
  
DOC="""<p><b>Press CTRL+S to save/preview !!</b></p>
<p><i> The main HTag's Tag should be named <b>App</b></i></p>"""

dataurl = lambda html: "data:text/html,"+urllib.parse.quote( html )
clean=lambda t: "\n".join( [i.strip(" \t\r\n") for i in t.splitlines()] )
class PyEditor(Tag.body):
    statics = [
        Tag.style("html, body {width:100%;height:100%;margin:0px}"),
    ]
    
    def init(self,code:str=""):
        self.ed = Ed(code or SRC, onchange=self.preview)
        self.iframe = Tag.iframe(
            _src=dataurl(DOC),
            _style="width:100%;height:100%",
        )
        
        # draw ui
        self <= Tag.div(self.ed+self.iframe,_style="display:flex;height:100vh")
        
    def preview(self,o):
        code = o.value.strip()
        self.iframe["src"]= dataurl( generate_pyscript(code) )
    
###############################################################################
from htag.runners import PyScript
from js import window

PyScript( PyEditor ).run( window )

</py-script>
</body>
</html>
