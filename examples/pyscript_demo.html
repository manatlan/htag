<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/mode-python.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/theme-cobalt.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ext-searchbox.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ext-language_tools.js"></script>
    
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <py-config>packages = ["htag==0.9.22"]</py-config>    
</head>

<body> Loading DEMO ;-)

<py-script>
###############################################################################
from htag import Tag
import urllib.parse

class Ed(Tag.div):
    """ A class which embed the ace editor (python syntax) """
    def __init__(self,value,width="100%",height="100%",mode="python",onchange=None):
        self.value = value
        super().__init__(_style="width:%s;height:%s;" % (width,height))
        
        oed=Tag.div(self.value,_style="width:100%;height:100%;min-height:20px;")
        self <= oed
        self.onchange=onchange
    
        self.js = """
self.ed=ace.edit( "%s" );
self.ed.setTheme("ace/theme/cobalt");
self.ed.session.setMode("ace/mode/%s");
self.ed.session.setUseWrapMode(false);
self.ed.setOptions({"fontSize": "11pt"});
self.ed.setBehavioursEnabled(false);
self.ed.session.setUseWorker(false);
self.ed.getSession().setUseSoftTabs(true);

function commandSave () {%s}

self.ed.commands.addCommand({
    name: "commandSave",
    bindKey: {"win": "Ctrl-S",  "mac": "Command-S"},
    readOnly: "True",
    exec: commandSave,
})
""" % (id(oed),mode, self.bind._save( b"self.ed.getValue()"))

    def _save(self,value):
        self.value = value
        if self.onchange: self.onchange(self)

SRC="""
from htag import Tag

class App(Tag.body):
    def init(self):
        def say_hello(o):
            self <= Tag.li("hello")
        self <= Tag.button("click",_onclick = say_hello)
"""

import base64
# pyscript doesn't like pyscript tag in multiple place, so needed to encode the html structure
PYS=base64.b64decode(b'PCFET0NUWVBFIGh0bWw+CiAgPGh0bWw+CiAgPGhlYWQ+CiAgICAgIDxsaW5rIHJlbD0ic3R5bGVzaGVldCIgaHJlZj0iaHR0cHM6Ly9weXNjcmlwdC5uZXQvbGF0ZXN0L3B5c2NyaXB0LmNzcyIgLz4KICAgICAgPHNjcmlwdCBkZWZlciBzcmM9Imh0dHBzOi8vcHlzY3JpcHQubmV0L2xhdGVzdC9weXNjcmlwdC5qcyI+PC9zY3JpcHQ+CiAgICAgIDxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MSI+CiAgICAgIDxweS1jb25maWc+cGFja2FnZXMgPSBbImh0YWc9PTAuOS4yMiJdPC9weS1jb25maWc+ICAgIAogIDwvaGVhZD4KICA8Ym9keT4KICA8cHktc2NyaXB0PgogICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKICAlcwogICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKICBmcm9tIGh0YWcucnVubmVycyBpbXBvcnQgUHlTY3JpcHQKICBmcm9tIGpzIGltcG9ydCB3aW5kb3cKICBQeVNjcmlwdCggQXBwICApLnJ1biggd2luZG93ICkKICA8L3B5LXNjcmlwdD4KICA8L2JvZHk+CiAgPC9odG1sPgogIA==').decode()
assert isinstance(PYS,str)
            
DOC="""<p><b>Press CTRL+S to save/preview !!</b></p>
<p><i> The main HTag's Tag should be named <b>App</b></i></p>"""

dataurl = lambda html: "data:text/html,"+urllib.parse.quote(html)

class PyEditor(Tag.body):
    statics = [
        Tag.style("html, body {width:100%;height:100%;margin:0px}"),
    ]
    
    def init(self):
        self.ed = Ed(SRC, onchange=self.preview)
        self.iframe = Tag.iframe(
            _src=dataurl(DOC),
            _style="width:100%;height:100%",
        )
        
        # draw ui
        self <= Tag.div(self.ed+self.iframe,_style="display:flex;height:100vh")
        
    def preview(self,o):
        code = o.value.strip()
        self.iframe["src"]= dataurl( PYS % code )
    
###############################################################################
from htag.runners import PyScript
from js import window

PyScript( PyEditor ).run( window )

</py-script>
</body>
</html>
