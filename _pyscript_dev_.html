<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <py-config>
    packages = ["htag"]
    </py-config>
</head>

<body> loading pyscript ;-)

<py-script>

from htag import Tag

class QRCode(Tag.div):
    statics=Tag.script(_src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js")

    def init(self,txt,size=128):
        self.js=f"""
new QRCode( self, {{
    text: `{txt}`,
    width: {size},
    height: {size},
    colorDark : "#000000",
    colorLight : "#ffffff",
    correctLevel : QRCode.CorrectLevel.H
}})"""

class App(Tag.div):
    imports=[QRCode]
    def init(self):
        self+=QRCode("https://my.netlib.re/htag/index/ed#/htag/QRCODE",256)

###############################################################################
from htag.render import HRenderer
from htag.runners import commons

import json

class PyScript:

    def __init__(self,tagClass:type):
        assert issubclass(tagClass,Tag)
        self.tagClass=tagClass

    def run(self,window): # window: "pyscript js.window"

        js = """
interact=async function(o) {
 action( await window.interactions( JSON.stringify(o) ) );
}

function pyscript_starter() {
    if(document.querySelector("*[needToLoadIt]"))
        window.setTimeout( pyscript_starter, 100 )
    else
        window.start()
}
"""
        self.hr = HRenderer(self.tagClass, js, init=commons.url2ak( window.document.location.href ))

        window.interactions = self.interactions
        assert window.document.head, "No <head> in <html>"
        assert window.document.body, "No <body> in <html>"

        # install statics in headers
        window.document.head.innerHTML=""
        for s in self.hr._statics:
            if isinstance(s,Tag):
                tag=window.document.createElement(s.tag)
                tag.innerHTML = "".join([str(i) for i in s.childs if i is not None])
                for key,value in s.attrs.items():
                    setattr(tag, key, value)
                    if key in ["src","href"]:
                        tag.setAttribute("needToLoadIt", True)
                        tag.onload = lambda o: o.target.removeAttribute("needToLoadIt")

                window.document.head.appendChild(tag)

        # install the first object in body
        window.document.body.outerHTML=str(self.hr)

        # and start the process
        window.pyscript_starter()

    async def interactions(self, o):
        data=json.loads(o)
        actions = await self.hr.interact( data["id"], data["method"], data["args"], data["kargs"], data.get("event") )
        return json.dumps(actions)

###############################################################################
#from htag.runners import PyScript
from js import window

PyScript( App  ).run( window )

</py-script>
</body>
</html>
